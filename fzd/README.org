#+TITLE: ISD2180与云平台数据通讯协议
#+AUTHOR: dongkechang
#+EMAIL: dongkechang@foxmail.com

#+LATEX_CLASS: article
#+LATEX_CLASS_OPTIONS: [a4paper]
#+LATEX_HEADER: \usepackage[margin=1in]{geometry}
#+LATEX_HEADER: \usepackage{ctex}
#+LATEX_HEADER: \usepackage{xltxtra}
#+LATEX_HEADER: \usepackage{fontspec, xunicode, xltxtra}
#+LATEX_HEADER: \usepackage{fancyhdr, lastpage}
#+LATEX_HEADER: \fancyhead[L,C]{}
#+LATEX_HEADER: \fancyfoot{}
#+LATEX_HEADER: \fancyhead[R]{法智达(北京)科技有限公司}
#+LATEX_HEADER: \fancyfoot[L]{版权所有}
#+LATEX_HEADER: \fancyfoot[R]{\thepage}
#+LATEX_HEADER: \renewcommand{\footrulewidth}{0.4pt}
#+LATEX_HEADER: \pagestyle{fancy}
#+LATEX_HEADER: \usepackage[tocentry, nochapter, owncaptions, tablegrid]{vhistory}
#+EXPORT_FILE_NAME: ISD2180_protocol_1.02.pdf
#+OPTIONS: toc:nil

#+BEGIN_versionhistory
  \vhEntry{1.0}{3/01/2022}{dongkechang}{1.新创建}
  \vhEntry{1.01}{7/01/2022}{dongkechang}{1.添加订阅发布主题}
  \vhEntry{1.02}{7/01/2022}{dongkechang}{1.添加float类型到Axis}
#+END_versionhistory

@@latex:\clearpage@@
#+TOC: headlines 2

@@latex:\clearpage@@

* ISD2180基本功能
ISD2180通过modbus协议收集rs485总线上的各个传感器数据,并按照此协议定义的格式将数据发送到云端,同时接收云平台对下发的指令,执行相应的动作.
* 通讯方式
** 4G或者以太网
通过4G网络或者直接通过有线接入云平台. 传输层采用mqtt协议.
* 通讯协议
** 传输层采用mqtt
2. mqtt协议详见官方主页https://mqtt.org 协议细节在此不在赘述
2. 应用层采用protobuf, 嵌入式端采用相应的语言编译器[[https://jpa.kapsi.fi/nanopb/][nanopb]] 服务器端采用官方语言编译器[[https://github.com/protocolbuffers/protobuf][protobuf]]

** ISD2180与云平台通讯主题
根据数据网关与云平台交互的消息,内容分为多个上报topic.(topic采用树形方式,发布和订阅双方交互信息),其组织结构类型如下:
#+ATTR_LATEX: :environment longtable :align |l|l|l|l|
|-----------------+-------------------+------+-----------------|
| 类型            | 主题名称          | 消息 | 用途            |
|-----------------+-------------------+------+-----------------|
| ISD2180上报数据 | /ISD2180/data     | Data | ISD2180上传数据 |
| ISD2180接收命令 | /ISD2180/{id}/cmd | Cmd  | 云端命令下发    |
|-----------------+-------------------+------+-----------------|

** 数据交互时序图
ISD2180与云平台数据交互时序图如下
#+BEGIN_SRC plantuml :cmdline -charset utf8 :file /tmp/app.png
skinparam sequenceArrowThickness 2
skinparam roundcorner 20
skinparam sequenceParticipant underline

scale 1.0
autonumber
participant "ISD2180"  as g
participant "mqtt服务器" as m
participant "云平台" as a

a -> m : 服务启动时连接mqtt服务器
a -> m : 订阅"/ISD2180/data"主题
g -> m : 连接mqtt服务器
g -> m : 订阅"/ISD2180/{id}/cmd"主题
g -> m : ISD2180将消息Data发布到"/ISD2180/data"
m -> a : 云平台接收到消息Data
m <- a : 云平台下发消息/ISD2180/{id}/cmd
g <- m : ISD2180接收Reply消息
m <- a : 云平台下发消息/ISD2180/{id}/cmd
g <- m : ISD2180接收Cmd消息
g -> m : ISD2180将消息Data发布到"/ISD2180/data"
m -> a : 云平台接收到消息
#+END_SRC

#+results:
[[file:/tmp/app.png]]

*** ISD2180与云平台交互消息
ISD2180和云平台应用层消息如下:
#+BEGIN_EXAMPLE
syntax = "proto2";

// 命令类型
enum CmdType{
    CMD_GET_1       = 1;
    CMD_SET_1       = 2;
    CMD_GET_REPLY_1 = 3;
    CMD_SET_REPLY_1 = 4;
    CMD_DATA        = 5;
    CMD_SLEEP       = 6;
}

// 参数
message Param {
  optional uint32 collectPeriod   = 1;
  optional uint32 tranmitPeriod   = 2;
  optional string firmwareVersion = 3;
  optional string hardwareVersion = 4;
}

// 通用数据上报消息类型,
message Data {
  required string id        = 1 [(nanopb).max_length = 19];
  required CmdType cmd      = 2;
  required uint32 timestamp = 3;
  repeated uint32 YuLiang   = 4;
  repeated uint32 ChenJiang = 5;
  repeated uint32 ShuiWei   = 6;
  repeated uint32 NiShui    = 7;
  repeated Axis   CeXie     = 8;
  optional Param  params    = 9;
}

message Axis {
  required float x = 1;
  required float y = 2;
  required float z = 3;
}

message Cmd {
  required string id        = 1 [(nanopb).max_length = 19];
  required CmdType cmd      = 2;
  required uint32 timestamp = 3;
  optional Param params     = 4;
}

#+END_EXAMPLE
** 连接mqtt服务器
1. ISD2180设置用户名,密码, qos, 连接地址和端口等连接信息发起连接请求
** 发送终端采集到的数据
1. 向主题"/ISD2180/data"发送类型为Data的消息
2. 检查AT指令对应的返回值,确认发送成功
** 接收命令
1. 订阅主题"/ISD2180/{id}/cmd"
2. 检查AT指令对应的返回值,确认订阅成功